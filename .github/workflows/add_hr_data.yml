- name: Update HR_DATA secret
        env:
          GH_TOKEN: ${{ secrets.PAT_FOR_SECRETS }}
          GH_REPO: ${{ github.repository }}
          EXISTING_HR_JSON: ${{ secrets.HR_DATA }}
          NEW_HR_DATA: ${{ github.event.inputs.newHrData }} # This name comes from the Vercel function
        shell: bash
        run: |
          python << 'EOF'
          import os
          import json
          import subprocess

          try:
              # Load existing data
              existing_hr_str = os.environ.get('EXISTING_HR_JSON', '{}')
              existing_hr_data = json.loads(existing_hr_str)

              # Load new data
              new_hr_str = os.environ['NEW_HR_DATA']
              new_hr_data = json.loads(new_hr_str)
              
              # --- START: CORRECTED LOGIC ---
              # Extract the name and values from the new data
              name = new_hr_data.get('name')
              hr_values = new_hr_data.get('hr_values')

              if not name or not hr_values:
                  print("Error: 'name' or 'hr_values' was missing from the new data.")
                  exit(1)

              # Correctly add the new user to the existing dictionary
              existing_hr_data[name] = hr_values
              updated_hr_data = existing_hr_data
              # --- END: CORRECTED LOGIC ---

              # Convert the final, correct dictionary back to a JSON string
              updated_hr_json_str = json.dumps(updated_hr_data)
              
              print(f'Updating HR_DATA secret for user: {name}')
              # Use subprocess to call the GitHub CLI and update the secret
              result = subprocess.run(
                  ['gh', 'secret', 'set', 'HR_DATA', '--body', updated_hr_json_str],
                  check=True, text=True, capture_output=True
              )
              print('âœ… Successfully updated HR_DATA secret.')
              print(result.stdout) # Print any output from the gh command for verification

          except Exception as e:
              print(f'An error occurred: {e}')
              exit(1)
          EOF
